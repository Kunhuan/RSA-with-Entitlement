# RSAE: Rational Speech Act with Entitlement

本项目实现并比较两种语用学模型：传统的理性言说行为模型(RSA, Rational Speech Act)和引入资格参数的扩展模型(RSAE, Rational Speech Act with Entitlement)。
本项目所有代码已做匿名化处理

## 项目概述

RSAE项目旨在通过计算模型验证语用学理论，特别是探索说话者资格(Entitlement)对语言交流的影响，并探索基于大规模数据的RSA模型研究进路。项目基于PersonaChat对话数据集（[Cynaptics/persona-chat · Datasets at Hugging Face](https://huggingface.co/datasets/Cynaptics/persona-chat)），通过以下步骤实现：

1. **数据提取与预处理**：从PersonaChat数据集中提取对话utterances，区分说话者(A/B)和对话ID
2. **语义向量建模**：使用SBERT将utterances编码为向量表示
3. **语义聚类**：通过MiniBatchKMeans将utterances聚类，形成"意义空间"
4. **RSA/RSAE建模**：基于聚类结果构建理性言说行为模型，计算语用推理概率

## 理论基础

### RSA 模型

#### 基础组件

1.  **意义空间 (Meaning Space, M)**
    -   **实现**: 由聚类模型的150个聚类中心向量构成。
    -   **表示**: `meaning_space` (大小: `150 x 768`)

2.  **言说空间 (Utterance Space, U)**
    -   **定义**: 由语料库中所有utterances的SBERT句向量构成。
    -   **表示**: `utterance_space` (大小: `n_utterances x 768`)

3.  **成本函数 (Cost Function, cost(u))**
    -   **定义**: 基于信息论，将言说的成本定义为其自信息。罕见或意外的言说具有更高的成本。
    -   **公式**: `cost(u) = -log(P(u))`
    -   **实现**: 使用Unigram模型计算句子概率`P(u)`。成本被预计算并保存在一个单独的文件中。

4.  **全局先验信念 (Global Prior Beliefs, P_global(m))**
    -   **定义**: 基于聚类密度计算的静态先验，反映语料库中各语义类别的自然分布。
    -   **公式**: `P_global(m_i) = count(samples in cluster i) / total_samples`

#### 推理流程

1.  **字面听者 (Literal Listener, L0)**
    -   **定义**: 基础语义理解层。由于采用硬聚类，其逻辑被简化。
    -   **公式**: `P_L0(m|u) = 1` 如果言说`u`属于意义`m`的聚类，否则为 `0`。这本质上是一个Delta函数 `δ(m ∈ ⟦u⟧)`。
    -   **作用**: 为语用说者提供基础的效用计算依据。

2.  **言说效用 (Utterance Utility, U(u,m))**
    -   **定义**: 衡量一个言说`u`在多大程度上能让字面听者相信意义`m`，同时考虑其成本。
    -   **公式**: `U(u, m) = log(P_L0(m|u)) - cost(u)`

3.  **语用说者 (Pragmatic Speaker, S1)**
    -   **定义**: 根据言说效用选择最优的言说方式。
    -   **公式**: `P_S1(u|m) = softmax(α * U(u,m))`，其中`α`是理性参数。

4.  **语用听者 (Pragmatic Listener, L1)**
    -   **定义**: 通过贝叶斯推断，结合说者模型和动态先验信念来更新自己对说者意图的理解。
    -   **公式**: `P_L1(m|u) ∝ P_S1(u|m) * P_dynamic(m)`
    -   **动态先验 `P_dynamic(m)`**:
        - **理论**: 听者的先验信念应随着对话历史动态更新。
        - **公式**: `P_dynamic(m) = w × P_global(m) + (1-w) × P_{L1}_{t-1}(m)`，其中 `w` 是`fusion_weight`，`P_{L1}_{t-1}(m)`是上一轮的听者信念。

---

### RSAE 模型

RSAE模型继承了RSA的所有基础组件，但在**语用说者**和**多轮对话处理**上有两个核心创新。

1.  **混合语用说者 (Mixture Pragmatic Speaker)**
    -   **理论**: 引入资格参数`E`，它代表听者B认为说者A在多大程度上是理性的。`E`值越高，A的表现越接近标准RSA语用说者。
    -   **公式**: `P_S1(u|m) = E × P_standard(u|m) + (1-E) × P_utility(u|m)`
        - `P_standard`: 与RSA中的`P_S1`相同。
        - `P_utility`: `softmax(α * β * U(u,m))`，用于刻画削弱后的语用说者影响，由`β`参数调节。

2.  **资格参数E的动态更新**
    -   **理论**: `E`值不是固定的，而是根据A在每一轮的沟通表现动态更新。
    -   **更新公式**: `E_{t+1} = (1-λ) × E_t + λ × performance_score_t`
    -   **表现评分**: 由四个可配置的维度加权构成，所有权重在`global_config.py`中统一管理：
        1.  **理解效果**：通过“熵减少量”衡量A的发言在多大程度上减少了B的不确定性。
        2.  **表达效果**：`P_S1(u|m) / P_L0(m|u)`的比值，衡量A的表达是否清晰、技巧是否高超。
        3.  **成本效率**：`理解效果 / 言说成本`，体现说者的语言表达水平和交流严肃程度。
        4.  **身份-主题契合度**：为降低实验复杂度，以及考虑到PersonaChat数据集以日常对话为主，身份与主题契合度普遍高，因此本项目将其设定为一个固定的`S`分数。

## 项目结构

```
.
├── README.md                   # 项目说明文档
├── requirements.txt            # Python依赖库
├── global_config.py            # 全局配置文件，统一管理路径和模型超参数
│
├── data/                         # 存放原始数据 (如 PersonaChat)
│
├── preprocessing/                # 数据预处理脚本
│   ├── extract_utterances.py     # 1. 从原始数据提取对话utterances
│   ├── encode_utterances.py      # 2. 将utterances编码为SBERT句向量
│   └── cluster_utterances.py     # 3. 将句向量聚类，形成"意义空间"
│
├── cost/                         # 信息成本计算模块
│   └── calculate_information_cost.py # 4. 基于Unigram模型计算每个utterance的信息成本
│
├── models/                       # 核心模型实现
│   ├── rsa/                      # 标准RSA模型
│   │   ├── generate_rsa.py       #   - 包含动态先验的标准RSA模型
│   │   └── generate_rsa_old.py   #   - 不含动态先验的经典RSA模型（用于对比）
│   └── rsae/                     # RSAE模型
│       └── generate_rsae.py      #   - 引入资格参数E的扩展RSA模型
│
└── results/                      # 存放所有实验生成的结果文件
    ├── extracted_u/              # 提取的utterances
    ├── embedding_u/              # utterances的句向量
    ├── cluster/                  # 聚类结果（模型、标签、摘要）
    ├── cost/                     # 计算出的信息成本
    ├── rsa/                      # RSA模型评估结果
    └── rsae/                     # RSAE模型评估结果
```

## 实验流程与结果摘要

### 1. 数据提取与统计

从PersonaChat数据集中提取对话utterances，保存为CSV格式，并进行统计。

-   **过程**: 去除了没有B参考回复的对话及B的人格描述，以精简实验流程，避免过度复杂的语用环境干扰。
-   **结果**:
    -   总对话数: 19,987
    -   总utterances数: 241,754
    -   平均每个对话的utterances数: 12.10
    -   Persona A的utterances数量: 120,846
    -   Persona B的utterances数量: 100,921

### 2. 语义向量编码

使用SBERT将所有utterances编码为向量表示。

-   **模型**: `all-mpnet-base-v2`
-   **结果**:
    -   句向量数量: 241,754
    -   向量维度: 768
    -   文本长度分布: 平均 11.3 词，中位数 10 词

### 3. 语义聚类与质量评估

使用MiniBatchKMeans算法将utterances聚类为150个语义类别，形成“意义空间”。

-   **聚类质量评估** (基于10,000样本):
    -   轮廓系数 (Silhouette Score): **0.0556**
    -   Calinski-Harabasz指数: 43.91
-   **结果解读**: 轮廓系数较低，有两个主要原因：(1) **硬聚类的局限性**：KMeans这类硬聚类算法会强制每个utterance只属于一个类别，而无法表达语义的交叉和重叠。(2) **日常对话特征**：PersonaChat作为日常闲聊数据集，其话题本身就具有高度的模糊性、多义性和主题漂移，这使得清晰的语义边界客观上难以划分，此数值符合日常对话实际。

### 4. 基准模型改进：动态先验信念

在经典的RSA模型中，语用听者`L1`通过贝叶斯更新吸收信息，但其先验信念`P(m)`通常是固定的全局先验。在面对平均长度达12轮的日常对话时，这种静态机制对于捕捉动态变化的语境信息显得力不从心。

-   **改进方案**: 我们将`L1`公式中的先验信念修改为结合了上一轮听者后验信念的**动态联合信念**。
-   **对比实验**: 在10,000个对话的抽样实验中，应用了动态先验的RSA模型相较于未使用该机制的经典RSA模型，**Top-3和Top-5预测准确率分别提高了8.2%和9.1%**，而熵仅微增0.091。
-   **结论**: 这一结果证明了动态先验机制在长对话情境下的有效性。因此，为确保比较的公平性和基准的强度，我们后续实验中使用的**RSA和RSAE模型均采用了此动态先验信念机制**。

### 5. 核心评估机制

1.  **Top-K准确率 (Top-K Accuracy)**: 比较模型预测的信念分布中，真实答案的排名。Top-1/3/5是核心指标。
2.  **信念熵 (Belief Entropy)**: `H(P) = -∑ P(m) * log(P(m))`，衡量信念分布的不确定性。

### 6. 最终实验结论

| 指标 | RSA | RSAE | 相对改进 |
| :--- | :--- | :--- | :--- |
| **Top-1准确率** | 16.89% | 17.00% | +0.6% |
| **Top-3准确率** | 20.91% | 22.98% | +9.9% |
| **Top-5准确率** | 22.26% | 25.09% | +12.7% |
| **初始信念熵** | 4.915 | 4.915 | |
| **最终信念熵** | 0.391 | 2.267 | |
| **初始资格参数E** | N/A | 0.800 | |
| **最终资格参数E** | N/A | 0.463 | |

**核心发现与解读**:

1.  **Top-K准确率显著提升**:
    -   RSAE模型在Top-3和Top-5准确率上表现出显著优势，相对提升分别达到**9.9%**和**12.7%**。这表明，虽然最可能的预测（Top-1）改进有限，但RSAE能更有效地将真实答案捕捉到其预测范围的前几位中，这在处理具有多义性的日常对话时是一个更重要、鲁棒性更高的指标。

2.  **最终信念熵的合理提升**:
    -   与传统RSA模型将最终信念熵压缩到极低的0.391（存在过拟合风险）不同，RSAE的最终信念熵保持在**2.267**的较高水平，符合预期的1.5到2.5区间。它表明RSAE成功避免了对单一意义的过度自信，保留了对话在语义上的不确定性。这更符合PersonaChat作为日常闲聊数据集所具有的**多义性、模糊性和开放性**特征。

3.  **资格参数的动态收敛**:
    -   在对话过程中，平均资格参数`E`从初始的0.8显著降低到0.463。
    -   这有力地证明了模型成功捕捉到了日常对话的**随意性**和**非正式性**。在闲聊场景下，听者会动态地降低对说者时刻保持高度严肃的预期，而RSAE的资格参数`E`恰恰模拟了这一认知调整过程。

## 依赖环境
详见`requirements.txt`
